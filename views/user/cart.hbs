<div class="container py-5">
  <h2 class="mb-4 text-center">Your Cart ðŸ›’</h2>

  {{#if cartItems.length}}
    <div class="row g-4">
      {{#each cartItems}}
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="card shadow-sm h-100">

            <!-- Product Image -->
            <img 
              src="{{#if this.product.resizedImages.[0]}}/rimage/{{this.product.resizedImages.[0]}}{{else}}/placeholder.png{{/if}}" 
              class="card-img-top" 
              alt="{{this.product.name}}">

            <div class="card-body d-flex flex-column">
              <!-- Product Details -->
              <h5 class="card-title">{{this.product.name}}</h5>
              <p class="card-text text-muted flex-grow-1">{{this.product.description}}</p>
              <p class="card-text fw-bold text-success">Price: $<span id="price-{{this._id}}">{{this.product.price}}</span></p>

              <!-- Quantity Controls -->
              <div class="d-flex gap-2 align-items-center mb-2">
                <button class="btn btn-secondary btn-sm btn-decrease" data-id="{{this._id}}">-</button>
                <span class="text-center flex-grow-1" id="qty-{{this._id}}">{{this.quantity}}</span>
                <button class="btn btn-secondary btn-sm btn-increase" data-id="{{this._id}}">+</button>
              </div>

              <!-- Buttons -->
              <div class="d-flex gap-2 mt-auto">
                <form action="/cart/remove/{{this._id}}" method="POST" class="w-50">
                 <button class="btn btn-danger btn-sm w-100 btn-remove" data-id="{{this._id}}">
                  <i class="fa-solid fa-trash me-1"></i> Remove
                </button>

                </form>

                <form action="/buy-now/{{this.product._id}}" method="GET" class="w-50">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="fa-solid fa-bolt me-1"></i> Buy Now
                  </button>
                </form>
              </div>

            </div>
          </div>
        </div>
      {{/each}}
    </div>

    <!-- Total Amount -->
    <div class="mt-4 text-end">
      <h5>Total: $<span id="total-amount">{{totalAmount}}</span></h5>
    </div>

  {{else}}
    <p class="text-muted text-center">Your cart is empty.</p>
  {{/if}}
</div>

<script>
  // Increment/Decrement Quantity
  document.querySelectorAll('.btn-increase, .btn-decrease').forEach(btn => {
    btn.addEventListener('click', async () => {
      const cartId = btn.dataset.id;
      const action = btn.classList.contains('btn-increase') ? 'increase' : 'decrease';

      try {
        const res = await fetch(`/cart/update/${cartId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });

        if (res.ok) {
          const data = await res.json();
          // Update quantity
          document.getElementById(`qty-${cartId}`).textContent = data.quantity;
          // Update total
          document.getElementById('total-amount').textContent = data.totalAmount;
          // Update individual product price
          const priceEl = document.getElementById(`price-${cartId}`);
          priceEl.textContent = data.productTotal.toFixed(2);
        }
      } catch (err) {
        console.error(err);
      }
    });
  });
  // Remove cart item via AJAX
  document.querySelectorAll('.btn-remove').forEach(btn => {
    btn.addEventListener('click', async () => {
      const cartId = btn.dataset.id;
      if (!confirm("Are you sure you want to remove this item?")) return;

      try {
        const res = await fetch(`/cart/remove/${cartId}`, {
          method: 'POST'
        });

        if (res.ok) {
          // Remove the product card from DOM
          const card = btn.closest('.col-sm-6');
          card.remove();

          // Optionally, recalculate total
          const cartItems = document.querySelectorAll('.card-body');
          let total = 0;
          cartItems.forEach(item => {
            const priceEl = item.querySelector('span[id^="price-"]');
            const qtyEl = item.querySelector('span[id^="qty-"]');
            if (priceEl && qtyEl) {
              total += parseFloat(priceEl.textContent) * parseInt(qtyEl.textContent);
            }
          });
          document.getElementById('total-amount').textContent = total.toFixed(2);

          // If no items left
          if (cartItems.length === 0) {
            document.querySelector('.row.g-4').innerHTML = '<p class="text-muted text-center">Your cart is empty.</p>';
            document.getElementById('total-amount').textContent = '0.00';
          }
        } else {
          alert("Failed to remove item.");
        }
      } catch (err) {
        console.error(err);
      }
    });
  });
</script>
