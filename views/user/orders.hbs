<div class="container py-5">
  <h2 class="mb-4">Your Orders ðŸ“¦</h2>

  {{#if orders.length}}
    {{#each orders}}
    <div class="card mb-4 shadow-sm position-relative {{#if (eq this.status 'Cancelled')}}cancelled{{/if}}">
      <div class="card-body">
        <h5>Order #{{this._id}} 
          <span class="badge {{#if (eq this.status 'Cancelled')}}bg-danger{{else}}bg-info text-dark{{/if}}">
            {{this.statusLabel}}
          </span>
        </h5>
        <p><strong>Date:</strong> {{this.createdAt}}</p>
        <p><strong>Total:</strong> ${{this.totalAmount}}</p>

        <h6>Products & Shipping:</h6>
        {{#each this.products}}
        <div class="shipment-track my-3 position-relative">
          <div class="track">
            <div class="stage {{#if (gte ../progress 0)}}active{{/if}}">
              <i class="fa-solid fa-cart-shopping"></i> Ordered
            </div>
            <div class="stage {{#if (gte ../progress 25)}}active{{/if}}">
              <i class="fa-solid fa-check"></i> Accepted
            </div>
            <div class="stage {{#if (gte ../progress 50)}}active{{/if}}">
              <i class="fa-solid fa-truck"></i> Shipped
            </div>
            <div class="stage {{#if (gte ../progress 75)}}active{{/if}}">
              <i class="fa-solid fa-warehouse"></i> Near Hub
            </div>
            <div class="stage {{#if (gte ../progress 100)}}active{{/if}}">
              <i class="fa-solid fa-box-open"></i> Delivered
            </div>
          </div>

          <div class="progress-bar">
            <div class="fill" style="width: {{../progress}}%"></div>
          </div>

          <div class="product-box position-absolute" style="--progress: {{../progress}}%">
            <i class="fa-solid fa-box"></i> {{this.name}}
          </div>
        </div>
        {{/each}}

        <div class="mt-3 d-flex justify-content-end">
          {{#if this.canCancel}}
          <button type="button" class="btn btn-danger btn-sm btn-cancel" data-id="{{this._id}}">
            <i class="fa-solid fa-xmark me-1"></i> Cancel Order
          </button>
          {{/if}}
        </div>
      </div>
    </div>
    {{/each}}
  {{else}}
    <p class="text-muted">You have no orders yet.</p>
  {{/if}}
</div>
<style>
  .shipment-track {
  margin: 30px 0;
  position: relative;
}

.track {
  display: flex;
  justify-content: space-between;
  background: #eee;
  border-radius: 12px;
  padding: 12px 0;
  position: relative;
  z-index: 1;
}

.stage {
  flex: 1;
  text-align: center;
  font-size: 0.85rem;
  font-weight: 500;
  color: #bbb;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  transition: color 1s, font-weight 1s;
}

.stage i { font-size: 1.1rem; transition: color 1s; }

.stage.active { color: #28a745; font-weight: 600; }

.progress-bar {
  position: absolute;
  top: 25px;
  left: 0;
  height: 6px;
  width: 100%;
  background: linear-gradient(to right, #28a745 0%, #ccc 100%);
  border-radius: 3px;
  z-index: 0;
  overflow: hidden;
}

.progress-bar .fill {
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, #28a745, #00c853);
  border-radius: 3px;
  transition: width 1.5s ease-in-out;
}

.product-box {
  top: -35px;
  left: 0;
  display: flex;
  align-items: center;
  gap: 5px;
  background: #ff9800;
  color: #fff;
  padding: 5px 12px;
  border-radius: 15px;
  transform: translateX(var(--progress, 0%));
  transition: transform 1.5s ease-in-out, background 0.5s;
  font-size: 0.85rem;
}

.product-box i { font-size: 1rem; }

/* Grey out cancelled orders */
.card.cancelled { opacity: 0.6; pointer-events: none; }

</style>
<script>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  // Animate progress bars & product boxes
  document.querySelectorAll('.shipment-track').forEach(track => {
    const fill = track.querySelector('.fill');
    const box = track.querySelector('.product-box');
    const progress = parseFloat(box.style.getPropertyValue('--progress'));
    setTimeout(() => fill.style.width = progress + '%', 200);
    setTimeout(() => box.style.transform = `translateX(${progress}%)`, 200);
  });

  // Cancel order via AJAX
  document.querySelectorAll('.btn-cancel').forEach(btn => {
    btn.addEventListener('click', async () => {
      const orderId = btn.dataset.id;
      if(!confirm("Cancel this order?")) return;

      try {
        const res = await fetch(`/orders/cancel/${orderId}`, { method: 'POST' });
        if(res.ok){
          const card = btn.closest('.card');
          card.classList.add('cancelled');

          const badge = card.querySelector('.badge');
          badge.textContent = "Cancelled";
          badge.className = "badge bg-danger";

          // Animate product boxes & progress bar
          card.querySelectorAll('.product-box').forEach(box => {
            box.style.setProperty('--progress', '0%');
            box.style.transform = 'translateX(0%)';
            box.style.background = '#888';
          });
          card.querySelectorAll('.progress-bar .fill').forEach(fill => fill.style.width = '0%');

          btn.disabled = true;
        } else {
          alert("Failed to cancel order.");
        }
      } catch(err) { console.error(err); }
    });
  });
});
</script>

</script>
